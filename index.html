<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>bbb 投資戰情室</title>
    
    <!-- 核心套件 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg-color: #FDFBF7; --sidebar-bg: #F5F2EB; --accent: #8B7355; --text: #2C3E50; }
        body { background-color: var(--bg-color); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; overflow: hidden; }
        .card { background: white; border: 1px solid #E5E0D8; border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: relative; }
        .card-header { font-weight: bold; border-bottom: 2px solid #E5E0D8; padding-bottom: 0.5rem; margin-bottom: 1rem; color: var(--text); display: flex; justify-content: space-between; align-items: center;}
        
        /* 側邊欄美化 */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #D1C7B7; border-radius: 4px; }
        
        /* Loading 遮罩 */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 99; display: none; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body class="flex flex-col">

    <!-- Loading 遮罩 -->
    <div id="processingOverlay" class="loading-overlay">
        <div class="text-[#8B7355] text-6xl mb-6"><i class="fas fa-satellite-dish fa-spin"></i></div>
        <h2 class="text-2xl font-bold text-gray-700">正在呼叫 bbb 戰情室...</h2>
        <p class="text-gray-500 mt-2 text-lg">AI 正在全力分析 <span id="targetStock" class="font-bold text-[#8B7355]"></span></p>
        <p class="text-sm text-gray-400 mt-6 animate-pulse">連線中，請稍候約 60 秒...</p>
    </div>

    <!-- 頂部導航列 -->
    <header class="bg-[#ECE8DE] h-14 flex items-center px-6 border-b border-[#DCD6C9] shrink-0 justify-between">
        <div class="flex items-center gap-2">
            <i class="fas fa-chart-line text-[#8B7355]"></i>
            <div class="font-bold text-xl tracking-widest text-[#5A4A42]">bbb ANALYTICS</div>
        </div>
        <div class="flex items-center gap-4">
            <!-- 狀態燈號 -->
            <div id="systemStatus" class="text-xs font-mono px-2 py-1 rounded bg-gray-100 text-gray-500 flex items-center">
                <span class="inline-block w-2 h-2 rounded-full bg-yellow-400 mr-2 animate-pulse"></span> 初始化中...
            </div>
            <button onclick="fetchData(true)" class="bg-white border border-[#D1C7B7] text-[#8B7355] hover:bg-[#8B7355] hover:text-white transition px-3 py-1.5 rounded text-xs font-bold shadow-sm">
                <i class="fas fa-sync-alt mr-1"></i> 刷新
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- 左側：控制台 -->
        <aside class="w-1/3 max-w-sm bg-[#F5F2EB] border-r border-[#DCD6C9] flex flex-col z-10 shadow-lg">
            <div class="p-4 border-b border-[#E5E0D8]">
                <div class="relative group">
                    <input type="text" id="addStockInput" placeholder="輸入代號 (如 2330) 按 Enter" 
                           class="w-full bg-white border-2 border-[#D1C7B7] rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-[#8B7355] placeholder-gray-400 transition shadow-sm font-mono tracking-wide">
                    <button onclick="triggerAddStock()" class="absolute right-3 top-3 text-[#8B7355] hover:scale-110 transition" title="執行分析">
                        <i class="fas fa-plus-circle text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div id="stockListContainer" class="flex-1 overflow-y-auto p-3 space-y-3">
                <!-- 列表將在此渲染 -->
            </div>
        </aside>

        <!-- 右側：報告視窗 -->
        <main class="flex-1 overflow-y-auto p-8 bg-[#FDFBF7] relative scroll-smooth" id="mainContent">
            <!-- 空狀態 -->
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-gray-400 opacity-60">
                <i class="fas fa-search-location text-7xl mb-6 text-[#D1C7B7]"></i>
                <p class="text-xl font-light">請從左側清單選擇股票</p>
                <p class="text-sm mt-2">或輸入新代號進行 AI 分析</p>
            </div>

            <!-- 報告內容 -->
            <div id="reportContainer" class="hidden max-w-6xl mx-auto space-y-6 pb-20 fade-in">
                <!-- 頭部資訊 -->
                <div class="flex flex-col md:flex-row justify-between items-end border-b-2 border-[#8B7355] pb-4 mb-6">
                    <div>
                        <h1 class="text-4xl font-extrabold text-[#2C3E50] tracking-tight">
                            <span id="stockId" class="text-[#8B7355] mr-3 font-mono"></span>
                            <span id="stockName"></span>
                        </h1>
                        <p class="text-sm text-gray-500 mt-2 flex items-center">
                            <i class="far fa-clock mr-1.5"></i> 資料時間：<span id="updateDate" class="font-mono"></span>
                        </p>
                    </div>
                    <div class="text-right bg-white px-5 py-3 rounded-xl border border-gray-100 shadow-sm">
                        <div id="priceDisplay" class="text-4xl font-mono font-bold tracking-tight">--</div>
                        <div id="priceChange" class="text-sm font-bold mt-1 text-gray-400">--</div>
                    </div>
                </div>

                <!-- 投資筆記 -->
                <div class="bg-[#FFFDF5] border border-[#E8E0C0] rounded-lg p-5 shadow-sm">
                    <div class="text-xs font-bold text-[#8B7355] uppercase tracking-wider mb-2 flex items-center">
                        <i class="fas fa-sticky-note mr-2"></i> 投資筆記 (Local Memo)
                    </div>
                    <textarea id="memoArea" rows="2" 
                              class="w-full bg-transparent border-none resize-none text-gray-700 placeholder-gray-300 focus:ring-0 text-base leading-relaxed"
                              placeholder="點擊輸入心得，將自動儲存於此裝置..."></textarea>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 1. AI 基本面分析 -->
                    <div class="card overflow-hidden">
                        <div class="absolute top-0 right-0 bg-[#F5F2EB] text-[#8B7355] text-[10px] px-3 py-1 rounded-bl-lg border-l border-b border-[#E5E0D8] font-mono shadow-sm">
                            <i class="fas fa-microchip mr-1"></i><span id="aiModelTag">AI</span>
                        </div>
                        <div class="card-header pt-2">
                            <span><i class="fas fa-shield-alt text-[#8B7355] mr-2"></i> 護城河與 AI 評鑑</span>
                            <span id="moatStatus" class="text-xs bg-yellow-50 text-yellow-700 px-2 py-1 rounded border border-yellow-100 font-bold ml-2">--</span>
                        </div>
                        <div class="text-[15px] text-gray-700 leading-7 text-justify">
                            <p id="moatDesc" class="min-h-[100px]">載入中...</p>
                        </div>
                    </div>

                    <!-- 2. 市場情緒與新聞 -->
                    <div class="card">
                        <div class="card-header pt-2">
                            <span><i class="fas fa-bullhorn text-[#8B7355] mr-2"></i> 近期市場消息</span>
                        </div>
                        <div id="newsList" class="space-y-0 max-h-[250px] overflow-y-auto"></div>
                    </div>
                </div>

                <!-- 3. 本益比河流圖 -->
                <div class="card">
                    <div class="card-header">
                        <span><i class="fas fa-water text-[#8B7355] mr-2"></i> 本益比河流圖 (Valuation River)</span>
                        <div class="text-xs font-normal text-gray-500 space-x-2">
                            <span><i class="fas fa-circle text-red-400 text-[8px]"></i> 20x</span>
                            <span><i class="fas fa-circle text-yellow-400 text-[8px]"></i> 16x</span>
                            <span><i class="fas fa-circle text-green-400 text-[8px]"></i> 12x</span>
                        </div>
                    </div>
                    <div class="h-80 w-full relative">
                        <canvas id="peRiverChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 4. 營收趨勢 -->
                    <div class="card">
                        <div class="card-header">
                            <span><i class="fas fa-chart-bar text-[#8B7355] mr-2"></i> 營收動能</span>
                        </div>
                        <div class="h-64 relative">
                            <canvas id="financialChart"></canvas>
                        </div>
                    </div>

                    <!-- 5. 技術面 AI -->
                    <div class="card border-l-[6px] border-l-[#8B7355]">
                        <div class="card-header">
                            <span><i class="fas fa-chess-board text-[#8B7355] mr-2"></i> 技術面 AI 策略</span>
                        </div>
                        <div class="space-y-5">
                            <p id="techAnalysis" class="text-sm text-gray-600 leading-relaxed text-justify">分析中...</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 text-center">
                                    <div class="text-xs text-gray-400 uppercase mb-1">布林通道狀態</div>
                                    <div id="bollingerDesc" class="font-bold text-sm text-[#2C3E50] truncate">--</div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 text-center">
                                    <div class="text-xs text-gray-400 uppercase mb-1">建議進場區間</div>
                                    <div id="entryZone" class="font-bold text-sm text-[#8B7355]">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ------------------------------------------
        // ⚠️ 請修改下面這一行就好
        // 把你的 github_pat_xxxx 完整貼在雙引號裡面
        // ------------------------------------------
        const GITHUB_TOKEN = "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";  
        // ☝️ 注意：開頭結尾要有引號 "..."，後面要有分號 ;

        const GITHUB_USER = "Mocha-lin"; 
        const GITHUB_REPO = "-3";

        // 系統變數
        let stocks = [];
        let currentStockId = null;
        let chartInstances = { pe: null, fin: null };

        // 啟動邏輯
        window.onload = async function() {
            renderSidebar();
            await fetchData(true); // 強制刷新
        };

        // 鍵盤監聽
        document.getElementById('addStockInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') triggerAddStock();
        });

        // 1. 數據抓取核心
        async function fetchData(force = false) {
            const statusBadge = document.getElementById('systemStatus');
            try {
                statusBadge.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-yellow-400 mr-2 animate-pulse"></span> 下載中...';
                
                const url = force ? `./data.json?t=${Date.now()}` : './data.json';
                const res = await fetch(url);
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const cloudData = await res.json();
                
                if (!Array.isArray(cloudData) || cloudData.length === 0) {
                    throw new Error("資料庫是空的");
                }

                // 合併本地 Memo
                const localStr = localStorage.getItem('bbb_db') || '[]';
                const localData = JSON.parse(localStr);
                
                stocks = cloudData.map(c => {
                    const l = localData.find(x => x.id === c.id);
                    if (l && l.memo) c.memo = l.memo;
                    return c;
                });
                
                localStorage.setItem('bbb_db', JSON.stringify(stocks));
                renderSidebar();
                
                if (currentStockId && stocks.find(s=>s.id === currentStockId)) {
                    loadStock(currentStockId);
                }
                
                statusBadge.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2"></span> 連線正常';
                statusBadge.className = "text-xs font-mono px-2 py-1 rounded bg-green-100 text-green-700 flex items-center";

            } catch (e) {
                console.error(e);
                statusBadge.innerHTML = `<span class="inline-block w-2 h-2 rounded-full bg-red-500 mr-2"></span> ${e.message}`;
                statusBadge.className = "text-xs font-mono px-2 py-1 rounded bg-red-50 text-red-700 flex items-center";
            }
        }

        // 2. 渲染左側清單
        function renderSidebar() {
            const list = document.getElementById('stockListContainer');
            list.innerHTML = '';
            
            if (!stocks.length) {
                list.innerHTML = `<div class="p-4 text-center text-gray-400 text-xs border border-dashed border-gray-300 rounded">尚無股票資料</div>`;
                return;
            }

            stocks.forEach(s => {
                const el = document.createElement('div');
                const isSelected = s.id === currentStockId;
                el.className = `p-4 mb-3 rounded-xl cursor-pointer border transition-all duration-200 group relative ${isSelected ? 'bg-white border-[#8B7355] shadow-md transform scale-[1.02]' : 'bg-white border-transparent hover:border-gray-300 hover:shadow-sm'}`;
                
                const chg = parseFloat(s.basicInfo?.change || 0);
                const colorClass = chg > 0 ? 'text-[#C0392B]' : (chg < 0 ? 'text-[#218C74]' : 'text-gray-400');
                
                el.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-extrabold text-[#2C3E50] text-lg font-mono">${s.id}</span>
                        <span class="text-sm font-bold font-mono ${colorClass}">${s.basicInfo?.price || '-'}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-500 truncate w-24 group-hover:text-[#8B7355] transition">${s.name}</span>
                        <span class="font-mono ${colorClass} bg-opacity-10 px-1.5 py-0.5 rounded ${chg > 0 ? 'bg-red-100' : (chg < 0 ? 'bg-green-100' : 'bg-gray-100')}">${s.basicInfo?.changePercent || '-'}</span>
                    </div>
                `;
                el.onclick = () => loadStock(s.id);
                list.appendChild(el);
            });
        }

        // 3. 顯示股票內容
        function loadStock(id) {
            currentStockId = id;
            const s = stocks.find(x => x.id === id);
            if (!s) return;

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('reportContainer').classList.remove('hidden');
            renderSidebar();

            setText('stockId', s.id);
            setText('stockName', s.name);
            setText('updateDate', s.lastUpdated);
            setText('aiModelTag', s.ai_model || 'AI');
            
            const pEl = document.getElementById('priceDisplay');
            const cEl = document.getElementById('priceChange');
            const chg = parseFloat(s.basicInfo?.change || 0);
            
            pEl.innerText = s.basicInfo?.price || '--';
            cEl.innerText = `${s.basicInfo?.change} (${s.basicInfo?.changePercent})`;
            pEl.className = `text-4xl font-mono font-bold tracking-tight ${chg > 0 ? 'text-[#C0392B]' : (chg < 0 ? 'text-[#218C74]' : 'text-[#2C3E50]')}`;
            cEl.className = `text-sm font-bold mt-1 ${chg > 0 ? 'text-[#C0392B]' : (chg < 0 ? 'text-[#218C74]' : 'text-gray-400')}`;

            const memoEl = document.getElementById('memoArea');
            memoEl.value = s.memo || "";
            memoEl.oninput = function() {
                s.memo = this.value;
                localStorage.setItem('bbb_db', JSON.stringify(stocks));
            };

            setText('moatStatus', s.moat?.status || 'N/A');
            setText('moatDesc', s.moat?.description || '載入中...');
            setText('techAnalysis', s.technical?.analysis || '載入中...');
            setText('bollingerDesc', s.technical?.bollinger?.description?.slice(0,25) + '...' || 'N/A');
            setText('entryZone', s.technical?.predictions?.entryZone || 'N/A');

            const nBox = document.getElementById('newsList');
            nBox.innerHTML = '';
            (s.news || []).forEach(n => {
                let icon = 'fa-circle text-gray-300';
                if(/增|漲|高|旺/.test(n.title)) icon = 'fa-caret-up text-red-500 text-lg -mt-1';
                if(/減|跌|低|淡/.test(n.title)) icon = 'fa-caret-down text-green-500 text-lg -mt-1';
                nBox.innerHTML += `
                    <div class="py-3 border-b border-gray-100 hover:bg-gray-50 transition px-2 rounded group">
                        <div class="flex items-start">
                            <div class="w-6 text-center"><i class="fas ${icon}"></i></div>
                            <div class="flex-1">
                                <div class="text-[10px] text-gray-400 font-mono mb-1">${n.date}</div>
                                <div class="text-[13px] text-[#2C3E50] group-hover:text-[#8B7355] transition font-medium">${n.title}</div>
                            </div>
                        </div>
                    </div>`;
            });

            renderCharts(s);
        }

        function renderCharts(s) {
            const ctxPe = document.getElementById('peRiverChart').getContext('2d');
            if (chartInstances.pe) chartInstances.pe.destroy();
            const pd = s.chartsData?.peRiverData || {dates:[], price:[]};
            
            chartInstances.pe = new Chart(ctxPe, {
                type: 'line',
                data: {
                    labels: pd.dates,
                    datasets: [
                        { label: 'Price', data: pd.price, borderColor: '#2C3E50', borderWidth: 2.5, pointRadius: 0 },
                        { label: '20x', data: pd.pe20, borderColor: '#F87171', borderDash:[4,4], borderWidth:1, pointRadius:0, fill:false },
                        { label: '16x', data: pd.pe16, borderColor: '#FACC15', borderDash:[4,4], borderWidth:1, pointRadius:0, fill:'-1', backgroundColor:'rgba(248,113,113,0.05)' },
                        { label: '12x', data: pd.pe12, borderColor: '#4ADE80', borderDash:[4,4], borderWidth:1, pointRadius:0, fill:'-1', backgroundColor:'rgba(250,204,21,0.1)' }
                    ]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{display:false},x:{display:false}} }
            });

            const ctxFin = document.getElementById('financialChart').getContext('2d');
            if (chartInstances.fin) chartInstances.fin.destroy();
            const rd = s.chartsData?.revenueTrend?.length ? s.chartsData.revenueTrend : Array(12).fill(0).map(()=>Math.random()*100+50);
            
            chartInstances.fin = new Chart(ctxFin, {
                type: 'bar',
                data: { labels: pd.dates, datasets: [{data: rd, backgroundColor:'#D1C7B7', borderRadius:4}] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}} }
            });
        }

        async function triggerAddStock() {
            const input = document.getElementById('addStockInput');
            const id = input.value.trim().toUpperCase();
            if(!id) return;
            
            if (GITHUB_TOKEN.includes("貼在")) { alert("尚未設定 Token，請修改 index.html"); return; }
            if (stocks.find(s=>s.id===id)) { alert("已存在"); loadStock(id); return; }
            if (!confirm(`確定要分析 ${id} 嗎？`)) return;

            document.getElementById('processingOverlay').style.display = 'flex';
            document.getElementById('targetStock').innerText = id;
            input.value = '';

            try {
                await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/dispatches`, {
                    method: 'POST',
                    headers: { 'Accept': 'application/vnd.github.v3+json', 'Authorization': `Bearer ${GITHUB_TOKEN}` },
                    body: JSON.stringify({ event_type: 'add_stock_trigger', client_payload: { stock_id: id } })
                });
                startPolling(id);
            } catch(e) {
                alert("發送失敗 (請檢查 Token 權限)");
                document.getElementById('processingOverlay').style.display = 'none';
            }
        }

        let pollTimer;
        function startPolling(tid) {
            let n = 0;
            if(pollTimer) clearInterval(pollTimer);
            pollTimer = setInterval(async ()=>{
                n++;
                try {
                    const res = await fetch(`./data.json?t=${Date.now()}`);
                    const data = await res.json();
                    if(data.find(s=>s.id===tid)) {
                        clearInterval(pollTimer);
                        await fetchData(true);
                        loadStock(tid);
                        document.getElementById('processingOverlay').style.display = 'none';
                    }
                } catch(e){}
                if(n>24) { 
                    clearInterval(pollTimer); 
                    document.getElementById('processingOverlay').style.display='none'; 
                    alert("更新等待逾時，請手動刷新"); 
                }
            }, 5000);
        }

        function setText(id, t) { const e=document.getElementById(id); if(e) e.innerText=t; }
</script>
</body>
</html>