<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>bbb æŠ•è³‡æˆ°æƒ…å®¤ Pro - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #FDFBF7; --side: #F5F2EB; --accent: #8B7355; --up: #218C74; --down: #C0392B; }
        body { background-color: var(--bg); display: flex; height: 100vh; overflow: hidden; font-family: -apple-system, sans-serif; }
        
        /* ä½ˆå±€æ¯”ä¾‹ 1:5 */
        #sidebar { width: 18%; background-color: var(--side); border-right: 1px solid #DCD6C9; display: flex; flex-direction: column; padding: 20px; }
        #main-content { width: 82%; overflow-y: auto; padding: 40px; }

        /* è¶¨å‹¢é–ƒçˆç‡ˆè™Ÿ */
        .pulse-launch { border-left: 6px solid var(--up) !important; animation: glow-up 2s infinite ease-in-out; }
        .pulse-fall { border-left: 6px solid var(--down) !important; animation: glow-down 2s infinite ease-in-out; }
        @keyframes glow-up { 0%, 100% { box-shadow: 0 0 5px rgba(33,140,116,0.2); } 50% { box-shadow: 0 0 20px rgba(33,140,116,0.5); } }
        @keyframes glow-down { 0%, 100% { box-shadow: 0 0 5px rgba(192,57,43,0.2); } 50% { box-shadow: 0 0 20px rgba(192,57,43,0.5); } }

        /* æ²è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #D1C7B7; border-radius: 10px; }
    </style>
</head>
<body>

<aside id="sidebar">
    <div class="mb-8">
        <h1 class="text-2xl font-black text-[#5A4A42]">bbb <span class="text-sm font-light">CLOUD</span></h1>
    </div>

    <div class="space-y-3 mb-8">
        <button onclick="fetchCloudData()" class="w-full bg-[#8B7355] text-white py-3 rounded-xl shadow-sm font-bold flex items-center justify-center active:scale-95 transition-all">
            <i class="fas fa-cloud-download-alt mr-2"></i>é›²ç«¯åŒæ­¥
        </button>
        <button onclick="manualImport()" class="w-full bg-white border border-[#8B7355] text-[#8B7355] py-2 rounded-xl text-xs font-bold active:bg-gray-50">
            æ‰‹å‹•åŒ¯å…¥ (å‚™æ´)
        </button>
    </div>

    <div id="stockList" class="flex-1 space-y-3 overflow-y-auto">
        </div>

    <button onclick="clearSystemCache()" class="mt-4 text-[10px] text-gray-400 hover:text-red-500 text-center w-full">
        <i class="fas fa-trash-alt mr-1"></i> æ¸…é™¤æœ¬åœ°ç·©å­˜æ•¸æ“š
    </button>
</aside>

<main id="main-content">
    <div id="empty-state" class="h-full flex flex-col items-center justify-center text-gray-300">
        <i class="fas fa-satellite text-6xl mb-4"></i>
        <p class="text-lg">é»æ“ŠåŒæ­¥æŒ‰éˆ•æˆ–é¸æ“‡æ¨™çš„</p>
    </div>

    <div id="report-view" class="hidden">
        <div class="flex justify-between items-end border-b-2 border-[#8B7355] pb-6 mb-10">
            <div>
                <span id="viewId" class="text-sm font-mono text-[#8B7355] font-bold"></span>
                <h2 id="viewName" class="text-5xl font-bold text-[#2C2C2C]"></h2>
            </div>
            <div class="text-right">
                <div id="viewPrice" class="text-5xl font-mono font-black"></div>
                <p id="viewTime" class="text-xs text-gray-400 mt-2"></p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
            <div class="bg-white p-6 rounded-2xl border border-[#E5E0D8] shadow-sm">
                <h3 class="font-bold mb-4 text-gray-700 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-[#8B7355]"></i>EPS å¹´åº¦ç²åˆ©è¶¨å‹¢
                </h3>
                <div style="height: 250px;">
                    <canvas id="epsChart"></canvas>
                </div>
            </div>

            <div class="bg-[#F9F7F2] p-6 rounded-2xl border border-[#D1C7B7] shadow-sm">
                <h3 class="font-bold mb-4 text-[#8B7355] flex items-center">
                    <i class="fas fa-calendar-alt mr-2"></i>æœªä¾†ä¸‰å€‹æœˆè¡Œäº‹æ›†
                </h3>
                <div id="calArea" class="space-y-3"></div>
            </div>
        </div>

        <div class="bg-white p-8 rounded-2xl border border-[#E5E0D8] shadow-sm">
            <h3 class="font-bold mb-4 text-gray-700">ğŸ¤– bbb æ¨¡å‹æ·±åº¦è§£æ</h3>
            <div id="techDesc" class="text-gray-600 leading-relaxed italic bg-[#FDFBF7] p-6 rounded-xl border-l-4 border-[#8B7355]"></div>
        </div>
    </div>
</main>

<script>
    let db = JSON.parse(localStorage.getItem('bbb_final_v1')) || {};
    let currentChart = null;

    // 1. åŒæ­¥ GitHub Actions ç”Ÿæˆçš„ data.json
    async function fetchCloudData() {
        try {
            // åŠ å…¥æ™‚é–“æˆ³é¿å…ç€è¦½å™¨å¿«å–èˆŠè³‡æ–™
            const response = await fetch('./data.json?t=' + Date.now());
            if (!response.ok) throw new Error();
            const cloudData = await response.json();
            
            // å¢é‡åˆä½µï¼šå°‡é›²ç«¯è³‡æ–™èˆ‡æœ¬åœ°è³‡æ–™åˆä½µ
            db = { ...db, ...cloudData };
            updateUI();
            alert("âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼");
        } catch (e) {
            alert("âŒ åŒæ­¥å¤±æ•—ï¼šæ‰¾ä¸åˆ° data.json æˆ–æ¬Šé™ä¸è¶³ã€‚è«‹ç¢ºèª GitHub Actions å·²æˆåŠŸåŸ·è¡Œã€‚");
        }
    }

    // 2. æ‰‹å‹•åŒ¯å…¥å‚™æ´
    function manualImport() {
        const raw = prompt("è«‹è²¼ä¸Š Google Colab ç”¢å‡ºçš„ JSON å…§å®¹ï¼š");
        if (!raw) return;
        try {
            const data = JSON.parse(raw);
            // å¦‚æœæ˜¯å–®ä¸€ç‰©ä»¶å‰‡è½‰ç‚ºå­—å…¸æ ¼å¼
            if (data.id) {
                db[data.id] = data;
            } else {
                db = { ...db, ...data };
            }
            updateUI();
        } catch (e) { alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿è¤‡è£½å®Œæ•´çš„å¤§æ‹¬è™Ÿã€‚"); }
    }

    // 3. æ¸…é™¤ç·©å­˜
    function clearSystemCache() {
        if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç·©å­˜å—ï¼Ÿé€™å°‡ä¸æœƒå½±éŸ¿ GitHub ä¸Šçš„è³‡æ–™ã€‚")) {
            localStorage.removeItem('bbb_final_v1');
            db = {};
            location.reload();
        }
    }

    function updateUI() {
        localStorage.setItem('bbb_final_v1', JSON.stringify(db));
        renderList();
    }

    function renderList() {
        const list = document.getElementById('stockList');
        const stocks = Object.values(db);
        if (stocks.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-400 text-xs mt-10">ç­‰å¾…æ•¸æ“šä¸­...</p>';
            return;
        }

        list.innerHTML = stocks.map(s => {
            let pulse = s.trend_status === 'ready_to_launch' ? 'pulse-launch' : 
                        (s.trend_status === 'ready_to_fall' ? 'pulse-fall' : '');
            return `
                <div onclick="showReport('${s.id}')" class="p-4 bg-white rounded-xl shadow-sm cursor-pointer border-l-4 border-transparent transition-all active:bg-gray-50 ${pulse}">
                    <div class="flex justify-between items-start">
                        <span class="font-black text-gray-800">${s.id}</span>
                        <span class="text-[9px] text-gray-400 font-mono">${s.lastUpdated.split(' ')[0]}</span>
                    </div>
                    <div class="text-xs text-gray-500 font-bold mt-1 truncate">${s.name}</div>
                </div>
            `;
        }).reverse().join('');
    }

    function showReport(id) {
        const s = db[id];
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('report-view').classList.remove('hidden');
        
        document.getElementById('viewId').innerText = id + '.TW';
        document.getElementById('viewName').innerText = s.name;
        document.getElementById('viewPrice').innerText = `$${s.price || s.basicInfo.price}`;
        document.getElementById('viewTime').innerText = `æœ€å¾Œæ ¡æº–æ™‚é–“: ${s.lastUpdated}`;
        document.getElementById('techDesc').innerText = s.technical.analysis || s.technical.k_line_analysis;

        // æ¸²æŸ“è¡Œäº‹æ›†
        const calArea = document.getElementById('calArea');
        calArea.innerHTML = s.calendar.map(c => `
            <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-[#E5E0D8] shadow-sm">
                <span class="text-xs font-bold text-gray-600">${c.event}</span>
                <span class="text-[10px] font-mono bg-[#8B7355] text-white px-2 py-1 rounded-md">${c.date}</span>
            </div>
        `).join('');

        // æ¸²æŸ“ Chart.js (EPS è¶¨å‹¢)
        if (s.eps_trend && s.eps_trend.length > 0) {
            renderChart(s.eps_trend);
        }
    }

    function renderChart(trendData) {
        const ctx = document.getElementById('epsChart').getContext('2d');
        if (currentChart) currentChart.destroy();

        currentChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trendData.map(d => d.year),
                datasets: [{
                    label: 'å¹´åº¦ EPS',
                    data: trendData.map(d => d.eps),
                    borderColor: '#8B7355',
                    backgroundColor: 'rgba(139, 115, 85, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: false, ticks: { font: { size: 10 } } }, x: { ticks: { font: { size: 10 } } } }
            }
        });
    }

    window.onload = renderList;
</script>
</body>
</html>
