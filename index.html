<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bbb æŠ•è³‡æˆ°æƒ…å®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-color: #FDFBF7; --sidebar-bg: #F5F2EB; }
        body { background-color: var(--bg-color); font-family: sans-serif; height: 100vh; overflow: hidden; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 50; display: none; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body class="flex flex-col">

    <!-- Loading é®ç½© -->
    <div id="processingOverlay" class="loading-overlay">
        <div class="text-[#8B7355] text-5xl mb-4"><i class="fas fa-cog fa-spin"></i></div>
        <h2 class="text-xl font-bold text-gray-700">æ­£åœ¨å‘¼å« bbb æˆ°æƒ…å®¤...</h2>
        <p class="text-gray-500 mt-2">AI æ­£åœ¨åˆ†æ <span id="targetStock" class="font-bold"></span>ï¼Œç´„éœ€ 1-2 åˆ†é˜</p>
        <p class="text-xs text-gray-400 mt-4">è«‹å‹¿é—œé–‰è¦–çª—ï¼Œå®Œæˆå¾Œå°‡è‡ªå‹•åˆ·æ–°</p>
    </div>

    <!-- Header -->
    <header class="bg-[#ECE8DE] h-12 flex items-center px-6 border-b border-[#DCD6C9] shrink-0 justify-between">
        <div class="font-bold text-lg tracking-widest text-[#5A4A42]">bbb ANALYTICS</div>
        <div class="text-xs text-gray-500" id="statusText">ç³»çµ±å¾…æ©Ÿä¸­</div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-1/4 bg-[#F5F2EB] border-r border-[#DCD6C9] flex flex-col z-10">
            <div class="p-3 border-b border-[#E5E0D8] bg-[#F5F2EB]">
                <!-- æœå°‹èˆ‡æ–°å¢å€ -->
                <div class="relative">
                    <input type="text" id="addStockInput" placeholder="è¼¸å…¥ä»£è™Ÿ (å¦‚ 2330) æŒ‰ Enter" 
                           class="w-full bg-white border-2 border-[#D1C7B7] rounded px-3 py-2 text-sm focus:outline-none focus:border-[#8B7355] placeholder-gray-400 transition">
                    <button onclick="triggerAddStock()" class="absolute right-2 top-2 text-[#8B7355] hover:text-black">
                        <i class="fas fa-plus-circle"></i>
                    </button>
                </div>
                <div class="text-[10px] text-gray-400 mt-1 text-center">è¼¸å…¥ä»£è™Ÿå¾Œè‡ªå‹•è§¸ç™¼ AI åˆ†æ</div>
            </div>
            <div id="stockListContainer" class="flex-1 overflow-y-auto p-2 pb-10"></div>
        </aside>

        <!-- Main Content (ç¶­æŒä¸è®Šçš„é¡¯ç¤ºé‚è¼¯) -->
        <main class="w-3/4 flex-1 overflow-y-auto p-6" id="mainContent">
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-search-dollar text-6xl mb-4 text-[#D1C7B7]"></i>
                <p>è«‹å¾å·¦å´é¸æ“‡æˆ–è¼¸å…¥ä»£è™Ÿæ–°å¢</p>
            </div>
            <div id="reportContainer" class="hidden space-y-6 max-w-5xl mx-auto">
                <!-- æ¨™é¡Œ -->
                <div class="flex justify-between items-end border-b-2 border-[#8B7355] pb-2">
                    <div>
                        <h1 class="text-3xl font-bold text-[#2C3E50]"><span id="stockId"></span> <span id="stockName"></span></h1>
                        <p class="text-xs text-gray-500 mt-1">æ›´æ–°: <span id="updateDate"></span></p>
                    </div>
                    <div id="priceDisplay" class="text-4xl font-mono font-bold"></div>
                </div>
                
                <!-- è­·åŸæ²³ & æ–°è -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded border shadow-sm">
                        <h3 class="font-bold mb-2 border-b">è­·åŸæ²³åˆ†æ</h3>
                        <p id="moatDesc" class="text-sm text-gray-700 leading-relaxed"></p>
                    </div>
                    <div class="bg-white p-4 rounded border shadow-sm">
                        <h3 class="font-bold mb-2 border-b">è¿‘æœŸæ–°è</h3>
                        <div id="newsList" class="space-y-2"></div>
                    </div>
                </div>

                <!-- æŠ€è¡“åˆ†æ -->
                <div class="bg-white p-4 rounded border shadow-sm border-l-4 border-l-[#8B7355]">
                    <h3 class="font-bold mb-2">AI æŠ€è¡“çŸ­è©•</h3>
                    <p id="techAnalysis" class="text-sm text-gray-700"></p>
                </div>
                
                <!-- åœ–è¡¨ -->
                <div class="bg-white p-4 rounded border shadow-sm h-64">
                    <canvas id="peRiverChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- è¨­å®šå€ ---
        // âš ï¸ è«‹å¡«å…¥ç¬¬ä¸€æ­¥ç”³è«‹çš„ Tokenï¼Œä¿ç•™ 'Bearer ' å‰ç¶´
        // æ³¨æ„ï¼šè‹¥æ˜¯å…¬é–‹ Repoï¼Œæ­¤ Token å¯èƒ½è¢«çœ‹è¦‹ã€‚å»ºè­° Repo è¨­ç‚º Private æˆ–ä½¿ç”¨ Scope æœ€å°çš„ Tokenã€‚
        const GITHUB_USER = "Mocha-lin"; // ä½ çš„ GitHub å¸³è™Ÿ
        const GITHUB_REPO = "-3";        // ä½ çš„ Repo åç¨±
        const GITHUB_TOKEN = "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"; // ç¯„ä¾‹: "ghp_xxxxxxxxxxxx"

        let stocks = [];
        let chartInstance = null;

        // åˆå§‹åŒ–
        window.onload = async () => {
            renderSidebar([]); // æ¸…ç©º
            await fetchData();
        };

        // æŒ‰ Enter è§¸ç™¼
        document.getElementById('addStockInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') triggerAddStock();
        });

        // 1. è§¸ç™¼æ–°å¢è‚¡ç¥¨ (Call GitHub API)
        async function triggerAddStock() {
            const input = document.getElementById('addStockInput');
            const stockId = input.value.trim();
            if (!stockId) return;

            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (stocks.find(s => s.id === stockId)) {
                alert("è©²è‚¡ç¥¨å·²åœ¨æ¸…å–®ä¸­ï¼");
                loadStock(stockId);
                input.value = "";
                return;
            }

            if (!confirm(`ç¢ºå®šè¦æ–°å¢ ${stockId} å—ï¼Ÿ\né€™å°‡è§¸ç™¼é›²ç«¯é‹ç®—ï¼Œéœ€ç­‰å¾…ç´„ 1-2 åˆ†é˜ã€‚`)) return;

            // é¡¯ç¤º Loading
            document.getElementById('processingOverlay').style.display = 'flex';
            document.getElementById('targetStock').innerText = stockId;
            input.value = "";

            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Authorization': `Bearer ${GITHUB_TOKEN}`
                    },
                    body: JSON.stringify({
                        event_type: 'add_stock_trigger',
                        client_payload: { stock_id: stockId }
                    })
                });

                if (response.ok) {
                    console.log("ğŸš€ æŒ‡ä»¤ç™¼é€æˆåŠŸï¼Œé–‹å§‹è¼ªè©¢...");
                    // é–‹å§‹è¼ªè©¢ (æ¯ 10 ç§’æª¢æŸ¥ä¸€æ¬¡ data.json æ˜¯å¦æœ‰æ–°è‚¡ç¥¨)
                    pollForData(stockId);
                } else {
                    throw new Error("GitHub API å›æ‡‰éŒ¯èª¤: " + response.status);
                }
            } catch (e) {
                alert("ç™¼é€å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token æˆ–ç¶²è·¯ã€‚\n" + e.message);
                document.getElementById('processingOverlay').style.display = 'none';
            }
        }

        // 2. è¼ªè©¢è³‡æ–™ (æª¢æŸ¥æ›´æ–°å¥½äº†æ²’)
        let pollCount = 0;
        function pollForData(targetId) {
            const interval = setInterval(async () => {
                pollCount++;
                document.getElementById('statusText').innerText = `ç³»çµ±é‹ç®—ä¸­... (${pollCount*10}s)`;
                
                try {
                    // å¼·åˆ¶æŠ“å–æœ€æ–°ç‰ˆ (åŠ äº‚æ•¸é¿å…å¿«å–)
                    const res = await fetch('./data.json?t=' + Date.now());
                    const newData = await res.json();
                    
                    // æª¢æŸ¥ç›®æ¨™è‚¡ç¥¨æ˜¯å¦å‡ºç¾
                    const found = newData.find(s => s.id === targetId);
                    if (found) {
                        clearInterval(interval);
                        stocks = newData;
                        renderSidebar();
                        loadStock(targetId);
                        document.getElementById('processingOverlay').style.display = 'none';
                        document.getElementById('statusText').innerText = "æ›´æ–°å®Œæˆ";
                        alert(`ğŸ‰ ${targetId} åˆ†æå®Œæˆï¼`);
                    }
                } catch (e) { console.log("ç­‰å¾…æ•¸æ“šä¸­..."); }

                // è¶…æ™‚æ©Ÿåˆ¶ (3åˆ†é˜)
                if (pollCount > 18) {
                    clearInterval(interval);
                    document.getElementById('processingOverlay').style.display = 'none';
                    alert("ç­‰å¾…é€¾æ™‚ã€‚GitHub Action å¯èƒ½é‚„åœ¨è·‘ï¼Œè«‹ç¨å¾Œæ‰‹å‹•åˆ·æ–°é é¢ã€‚");
                }
            }, 10000); // æ¯ 10 ç§’æª¢æŸ¥ä¸€æ¬¡
        }

        // 3. è®€å–è³‡æ–™
        async function fetchData() {
            try {
                const res = await fetch('./data.json?t=' + Date.now());
                stocks = await res.json();
                renderSidebar();
            } catch (e) { console.error(e); }
        }

        // 4. æ¸²æŸ“å´é‚Šæ¬„
        function renderSidebar() {
            const container = document.getElementById('stockListContainer');
            container.innerHTML = '';
            stocks.forEach(s => {
                const div = document.createElement('div');
                div.className = "p-3 mb-2 bg-white rounded shadow-sm cursor-pointer hover:bg-gray-50 border-l-4 border-transparent hover:border-[#8B7355]";
                div.innerHTML = `<div class="font-bold">${s.id} ${s.name}</div><div class="text-xs text-gray-500">${s.basicInfo.price} (${s.basicInfo.changePercent})</div>`;
                div.onclick = () => loadStock(s.id);
                container.appendChild(div);
            });
        }

        // 5. é¡¯ç¤ºè©³æƒ…
        function loadStock(id) {
            const s = stocks.find(i => i.id === id);
            if (!s) return;
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('reportContainer').classList.remove('hidden');
            
            document.getElementById('stockId').innerText = s.id;
            document.getElementById('stockName').innerText = s.name;
            document.getElementById('updateDate').innerText = s.lastUpdated;
            document.getElementById('priceDisplay').innerText = s.basicInfo.price;
            document.getElementById('moatDesc').innerText = s.moat?.description || "è³‡æ–™ä¸è¶³";
            document.getElementById('techAnalysis').innerText = s.technical?.analysis || "è³‡æ–™ä¸è¶³";
            
            const newsList = document.getElementById('newsList');
            newsList.innerHTML = '';
            (s.news || []).forEach(n => {
                newsList.innerHTML += `<div class="text-sm border-b pb-1 mb-1 last:border-0"><span class="text-xs text-gray-400 mr-2">${n.date}</span>${n.title}</div>`;
            });

            renderChart(s);
        }

        function renderChart(s) {
            const ctx = document.getElementById('peRiverChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            const d = s.chartsData?.peRiverData || { dates: [], price: [] };
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: d.dates,
                    datasets: [{ label: 'è‚¡åƒ¹', data: d.price, borderColor: '#2C3E50', tension: 0.2 }]
                },
                options: { maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>