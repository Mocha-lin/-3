<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>bbb æŠ•è³‡æˆ°æƒ…å®¤</title>
    
    <!-- æ ¸å¿ƒå¥—ä»¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg-color: #FDFBF7; --sidebar-bg: #F5F2EB; --accent: #8B7355; --text: #2C3E50; }
        body { background-color: var(--bg-color); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; overflow: hidden; }
        .card { background: white; border: 1px solid #E5E0D8; border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: relative; }
        .card-header { font-weight: bold; border-bottom: 2px solid #E5E0D8; padding-bottom: 0.5rem; margin-bottom: 1rem; color: var(--text); display: flex; justify-content: space-between; align-items: center;}
        
        /* å´é‚Šæ¬„ç¾åŒ– */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #D1C7B7; border-radius: 4px; }
        
        /* Loading é®ç½© */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 99; display: none; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body class="flex flex-col">

    <!-- Loading é®ç½© -->
    <div id="processingOverlay" class="loading-overlay">
        <div class="text-[#8B7355] text-6xl mb-6"><i class="fas fa-satellite-dish fa-spin"></i></div>
        <h2 class="text-2xl font-bold text-gray-700">æ­£åœ¨å‘¼å« bbb æˆ°æƒ…å®¤...</h2>
        <p class="text-gray-500 mt-2 text-lg">AI æ­£åœ¨å…¨åŠ›åˆ†æ <span id="targetStock" class="font-bold text-[#8B7355]"></span></p>
        <p class="text-sm text-gray-400 mt-6 animate-pulse">é€£ç·šä¸­ï¼Œè«‹ç¨å€™ç´„ 60 ç§’...</p>
    </div>

    <!-- é ‚éƒ¨å°èˆªåˆ— -->
    <header class="bg-[#ECE8DE] h-14 flex items-center px-6 border-b border-[#DCD6C9] shrink-0 justify-between">
        <div class="flex items-center gap-2">
            <i class="fas fa-chart-line text-[#8B7355]"></i>
            <div class="font-bold text-xl tracking-widest text-[#5A4A42]">bbb ANALYTICS</div>
        </div>
        <div class="flex items-center gap-4">
            <!-- ç‹€æ…‹ç‡ˆè™Ÿ -->
            <div id="systemStatus" class="text-xs font-mono px-2 py-1 rounded bg-gray-100 text-gray-500 flex items-center">
                <span class="inline-block w-2 h-2 rounded-full bg-yellow-400 mr-2 animate-pulse"></span> åˆå§‹åŒ–ä¸­...
            </div>
            <button onclick="fetchData(true)" class="bg-white border border-[#D1C7B7] text-[#8B7355] hover:bg-[#8B7355] hover:text-white transition px-3 py-1.5 rounded text-xs font-bold shadow-sm">
                <i class="fas fa-sync-alt mr-1"></i> åˆ·æ–°
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- å·¦å´ï¼šæ§åˆ¶å° -->
        <aside class="w-1/3 max-w-sm bg-[#F5F2EB] border-r border-[#DCD6C9] flex flex-col z-10 shadow-lg">
            <div class="p-4 border-b border-[#E5E0D8]">
                <div class="relative group">
                    <input type="text" id="addStockInput" placeholder="è¼¸å…¥ä»£è™Ÿ (å¦‚ 2330) æŒ‰ Enter" 
                           class="w-full bg-white border-2 border-[#D1C7B7] rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-[#8B7355] placeholder-gray-400 transition shadow-sm font-mono tracking-wide">
                    <button onclick="triggerAddStock()" class="absolute right-3 top-3 text-[#8B7355] hover:scale-110 transition" title="åŸ·è¡Œåˆ†æ">
                        <i class="fas fa-plus-circle text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div id="stockListContainer" class="flex-1 overflow-y-auto p-3 space-y-3">
                <!-- åˆ—è¡¨å°‡åœ¨æ­¤æ¸²æŸ“ -->
            </div>
        </aside>

        <!-- å³å´ï¼šå ±å‘Šè¦–çª— -->
        <main class="flex-1 overflow-y-auto p-8 bg-[#FDFBF7] relative scroll-smooth" id="mainContent">
            <!-- ç©ºç‹€æ…‹ -->
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-gray-400 opacity-60">
                <i class="fas fa-search-location text-7xl mb-6 text-[#D1C7B7]"></i>
                <p class="text-xl font-light">è«‹å¾å·¦å´æ¸…å–®é¸æ“‡è‚¡ç¥¨</p>
                <p class="text-sm mt-2">æˆ–è¼¸å…¥æ–°ä»£è™Ÿé€²è¡Œ AI åˆ†æ</p>
            </div>

            <!-- å ±å‘Šå…§å®¹ -->
            <div id="reportContainer" class="hidden max-w-6xl mx-auto space-y-6 pb-20 fade-in">
                <!-- é ­éƒ¨è³‡è¨Š -->
                <div class="flex flex-col md:flex-row justify-between items-end border-b-2 border-[#8B7355] pb-4 mb-6">
                    <div>
                        <h1 class="text-4xl font-extrabold text-[#2C3E50] tracking-tight">
                            <span id="stockId" class="text-[#8B7355] mr-3 font-mono"></span>
                            <span id="stockName"></span>
                        </h1>
                        <p class="text-sm text-gray-500 mt-2 flex items-center">
                            <i class="far fa-clock mr-1.5"></i> è³‡æ–™æ™‚é–“ï¼š<span id="updateDate" class="font-mono"></span>
                        </p>
                    </div>
                    <div class="text-right bg-white px-5 py-3 rounded-xl border border-gray-100 shadow-sm">
                        <div id="priceDisplay" class="text-4xl font-mono font-bold tracking-tight">--</div>
                        <div id="priceChange" class="text-sm font-bold mt-1 text-gray-400">--</div>
                    </div>
                </div>

                <!-- æŠ•è³‡ç­†è¨˜ -->
                <div class="bg-[#FFFDF5] border border-[#E8E0C0] rounded-lg p-5 shadow-sm">
                    <div class="text-xs font-bold text-[#8B7355] uppercase tracking-wider mb-2 flex items-center">
                        <i class="fas fa-sticky-note mr-2"></i> æŠ•è³‡ç­†è¨˜ (Local Memo)
                    </div>
                    <textarea id="memoArea" rows="2" 
                              class="w-full bg-transparent border-none resize-none text-gray-700 placeholder-gray-300 focus:ring-0 text-base leading-relaxed"
                              placeholder="é»æ“Šè¼¸å…¥å¿ƒå¾—ï¼Œå°‡è‡ªå‹•å„²å­˜æ–¼æ­¤è£ç½®..."></textarea>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 1. AI åŸºæœ¬é¢åˆ†æ -->
                    <div class="card overflow-hidden">
                        <div class="absolute top-0 right-0 bg-[#F5F2EB] text-[#8B7355] text-[10px] px-3 py-1 rounded-bl-lg border-l border-b border-[#E5E0D8] font-mono shadow-sm">
                            <i class="fas fa-microchip mr-1"></i><span id="aiModelTag">AI</span>
                        </div>
                        <div class="card-header pt-2">
                            <span><i class="fas fa-shield-alt text-[#8B7355] mr-2"></i> è­·åŸæ²³èˆ‡ AI è©•é‘‘</span>
                            <span id="moatStatus" class="text-xs bg-yellow-50 text-yellow-700 px-2 py-1 rounded border border-yellow-100 font-bold ml-2">--</span>
                        </div>
                        <div class="text-[15px] text-gray-700 leading-7 text-justify">
                            <p id="moatDesc" class="min-h-[100px]">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>

                    <!-- 2. å¸‚å ´æƒ…ç·’èˆ‡æ–°è -->
                    <div class="card">
                        <div class="card-header pt-2">
                            <span><i class="fas fa-bullhorn text-[#8B7355] mr-2"></i> è¿‘æœŸå¸‚å ´æ¶ˆæ¯</span>
                        </div>
                        <div id="newsList" class="space-y-0 max-h-[250px] overflow-y-auto"></div>
                    </div>
                </div>

                <!-- 3. æœ¬ç›Šæ¯”æ²³æµåœ– -->
                <div class="card">
                    <div class="card-header">
                        <span><i class="fas fa-water text-[#8B7355] mr-2"></i> æœ¬ç›Šæ¯”æ²³æµåœ– (Valuation River)</span>
                        <div class="text-xs font-normal text-gray-500 space-x-2">
                            <span><i class="fas fa-circle text-red-400 text-[8px]"></i> 20x</span>
                            <span><i class="fas fa-circle text-yellow-400 text-[8px]"></i> 16x</span>
                            <span><i class="fas fa-circle text-green-400 text-[8px]"></i> 12x</span>
                        </div>
                    </div>
                    <div class="h-80 w-full relative">
                        <canvas id="peRiverChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 4. ç‡Ÿæ”¶è¶¨å‹¢ -->
                    <div class="card">
                        <div class="card-header">
                            <span><i class="fas fa-chart-bar text-[#8B7355] mr-2"></i> ç‡Ÿæ”¶å‹•èƒ½</span>
                        </div>
                        <div class="h-64 relative">
                            <canvas id="financialChart"></canvas>
                        </div>
                    </div>

                    <!-- 5. æŠ€è¡“é¢ AI -->
                    <div class="card border-l-[6px] border-l-[#8B7355]">
                        <div class="card-header">
                            <span><i class="fas fa-chess-board text-[#8B7355] mr-2"></i> æŠ€è¡“é¢ AI ç­–ç•¥</span>
                        </div>
                        <div class="space-y-5">
                            <p id="techAnalysis" class="text-sm text-gray-600 leading-relaxed text-justify">åˆ†æä¸­...</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 text-center">
                                    <div class="text-xs text-gray-400 uppercase mb-1">å¸ƒæ—é€šé“ç‹€æ…‹</div>
                                    <div id="bollingerDesc" class="font-bold text-sm text-[#2C3E50] truncate">--</div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 text-center">
                                    <div class="text-xs text-gray-400 uppercase mb-1">å»ºè­°é€²å ´å€é–“</div>
                                    <div id="entryZone" class="font-bold text-sm text-[#8B7355]">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ------------------------------------------
        // âš ï¸ é‡è¦è¨­å®šå€ï¼šè«‹å¡«å…¥ Token æ‰èƒ½è‡ªå‹•æ–°å¢
        // ------------------------------------------
        const GITHUB_USER = "Mocha-lin"; 
        const GITHUB_REPO = "-3";
        const GITHUB_TOKEN = "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"; // <--- ğŸš¨ é€™è£¡è¦æ”¹ï¼ä¸è¦ç•™ä¸­æ–‡ï¼

        // ç³»çµ±è®Šæ•¸
        let stocks = [];
        let currentStockId = null;
        let chartInstances = { pe: null, fin: null };

        // å•Ÿå‹•é‚è¼¯
        window.onload = async function() {
            renderSidebar();
            await fetchData(true); // å¼·åˆ¶åˆ·æ–°æŠ“æœ€æ–°
        };

        // éµç›¤ç›£è½
        document.getElementById('addStockInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') triggerAddStock();
        });

        // 1. æ•¸æ“šæŠ“å–æ ¸å¿ƒ
        async function fetchData(force = false) {
            const statusBadge = document.getElementById('systemStatus');
            try {
                statusBadge.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-yellow-400 mr-2 animate-pulse"></span> ä¸‹è¼‰ä¸­...';
                
                const url = force ? `./data.json?t=${Date.now()}` : './data.json';
                const res = await fetch(url);
                
                if (!res.ok) throw new Error(`HTTP éŒ¯èª¤ ${res.status}`);
                
                const cloudData = await res.json();
                
                // è³‡æ–™åº«è‹¥ç‚ºç©ºï¼Œè¦–ç‚ºå‰›åˆå§‹åŒ–
                if (!Array.isArray(cloudData) || cloudData.length === 0) {
                    throw new Error("è³‡æ–™åº«æ˜¯ç©ºçš„ (è«‹å…ˆæ‰‹å‹•æ–°å¢è‡³å°‘ä¸€æ”¯è‚¡ç¥¨)");
                }

                // è®€å–æœ¬åœ° Memo åˆä½µ
                const localStr = localStorage.getItem('bbb_db') || '[]';
                const localData = JSON.parse(localStr);
                
                stocks = cloudData.map(c => {
                    const l = localData.find(x => x.id === c.id);
                    if (l && l.memo) c.memo = l.memo;
                    return c;
                });
                
                localStorage.setItem('bbb_db', JSON.stringify(stocks));
                renderSidebar();
                
                // åˆ·æ–°ç•¶å‰ç•«é¢
                if (currentStockId && stocks.find(s=>s.id === currentStockId)) {
                    loadStock(currentStockId);
                }
                
                statusBadge.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2"></span> ç³»çµ±é€£ç·šæ­£å¸¸';
                statusBadge.classList.replace('text-gray-500', 'text-green-700');
                statusBadge.classList.replace('bg-gray-100', 'bg-green-100');

            } catch (e) {
                console.error(e);
                statusBadge.innerHTML = `<span class="inline-block w-2 h-2 rounded-full bg-red-500 mr-2"></span> ${e.message}`;
                statusBadge.classList.replace('text-gray-500', 'text-red-700');
                statusBadge.classList.replace('bg-gray-100', 'bg-red-50');
            }
        }

        // 2. æ¸²æŸ“å·¦å´æ¸…å–®
        function renderSidebar() {
            const list = document.getElementById('stockListContainer');
            list.innerHTML = '';
            
            if (!stocks.length) {
                list.innerHTML = `<div class="p-4 text-center text-gray-400 text-xs border border-dashed border-gray-300 rounded">å°šç„¡è‚¡ç¥¨è³‡æ–™<br>è«‹åœ¨ä¸Šæ–¹è¼¸å…¥ä»£è™Ÿ</div>`;
                return;
            }

            stocks.forEach(s => {
                const el = document.createElement('div');
                const isSelected = s.id === currentStockId;
                el.className = `p-4 mb-3 rounded-xl cursor-pointer border transition-all duration-200 group relative ${isSelected ? 'bg-white border-[#8B7355] shadow-md transform scale-[1.02]' : 'bg-white border-transparent hover:border-gray-300 hover:shadow-sm'}`;
                
                const chg = parseFloat(s.basicInfo.change) || 0;
                const colorClass = chg > 0 ? 'text-[#C0392B]' : (chg < 0 ? 'text-[#218C74]' : 'text-gray-400');
                
                el.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-extrabold text-[#2C3E50] text-lg font-mono">${s.id}</span>
                        <span class="text-sm font-bold font-mono ${colorClass}">${s.basicInfo.price}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-500 truncate w-24 group-hover:text-[#8B7355] transition">${s.name}</span>
                        <span class="font-mono ${colorClass} bg-opacity-10 px-1.5 py-0.5 rounded ${chg > 0 ? 'bg-red-100' : (chg < 0 ? 'bg-green-100' : 'bg-gray-100')}">${s.basicInfo.changePercent}</span>
                    </div>
                `;
                el.onclick = () => loadStock(s.id);
                list.appendChild(el);
            });
        }

        // 3. é¡¯ç¤ºè‚¡ç¥¨å…§å®¹ (æ ¸å¿ƒ)
        function loadStock(id) {
            currentStockId = id;
            const s = stocks.find(x => x.id === id);
            if (!s) return;

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('reportContainer').classList.remove('hidden');
            renderSidebar(); // Update highlight

            // åŸºç¤å¡«å€¼
            setText('stockId', s.id);
            setText('stockName', s.name);
            setText('updateDate', s.lastUpdated);
            setText('aiModelTag', s.ai_model || 'Basic AI');
            
            // è‚¡åƒ¹è‘—è‰²
            const pEl = document.getElementById('priceDisplay');
            const cEl = document.getElementById('priceChange');
            const chg = parseFloat(s.basicInfo.change) || 0;
            pEl.innerText = s.basicInfo.price;
            cEl.innerText = `${s.basicInfo.change} (${s.basicInfo.changePercent})`;
            
            pEl.className = `text-4xl font-mono font-bold tracking-tight ${chg > 0 ? 'text-[#C0392B]' : (chg < 0 ? 'text-[#218C74]' : 'text-[#2C3E50]')}`;