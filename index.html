<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bbb æŠ•è³‡æˆ°æƒ…å®¤</title>
    <!-- å¼•å…¥å¤–éƒ¨å¥—ä»¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg-color: #FDFBF7; --sidebar-bg: #F5F2EB; --accent: #8B7355; --text: #2C3E50; }
        body { background-color: var(--bg-color); color: var(--text); font-family: sans-serif; height: 100vh; overflow: hidden; }
        /* å€å¡Šå¡ç‰‡æ¨£å¼ */
        .card { background: white; border: 1px solid #E5E0D8; border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: relative; }
        .card-header { font-weight: bold; border-bottom: 2px solid #E5E0D8; padding-bottom: 0.5rem; margin-bottom: 1rem; color: var(--text); display: flex; justify-content: space-between; align-items: center;}
        
        /* å´é‚Šæ¬„æ¨£å¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #D1C7B7; border-radius: 4px; }
        
        /* Loading é®ç½© */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 99; display: none; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body class="flex flex-col">

    <!-- 1. å…¨è¢å¹• Loading ç•«é¢ -->
    <div id="processingOverlay" class="loading-overlay">
        <div class="text-[#8B7355] text-5xl mb-4"><i class="fas fa-circle-notch fa-spin"></i></div>
        <h2 class="text-xl font-bold text-gray-700">æ­£åœ¨å‘¼å« bbb æˆ°æƒ…å®¤...</h2>
        <p class="text-gray-500 mt-2">AI æ­£åœ¨èª¿ç”¨æœ€æ–°æ¨¡å‹åˆ†æ <span id="targetStock" class="font-bold text-[#8B7355]"></span></p>
        <p class="text-xs text-gray-400 mt-4 animate-pulse">é‹ç®—ç´„éœ€ 60~90 ç§’ï¼Œè«‹è€å¿ƒç­‰å€™</p>
    </div>

    <!-- 2. é ‚éƒ¨ Header -->
    <header class="bg-[#ECE8DE] h-14 flex items-center px-6 border-b border-[#DCD6C9] shrink-0 justify-between">
        <div class="font-bold text-xl tracking-widest text-[#5A4A42]">bbb ANALYTICS</div>
        <div class="flex items-center gap-4">
            <div class="text-xs text-gray-500 hidden md:block" id="systemStatus">ğŸŸ¢ ç³»çµ±å¾…æ©Ÿä¸­</div>
            <button onclick="fetchData(true)" class="bg-white border border-[#D1C7B7] text-[#8B7355] hover:bg-[#8B7355] hover:text-white transition px-3 py-1 rounded text-xs">
                <i class="fas fa-sync-alt mr-1"></i> é‡æ•´æ•¸æ“š
            </button>
        </div>
    </header>

    <!-- 3. ä¸»ç‰ˆé¢ -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- å·¦å´ï¼šæœå°‹èˆ‡åˆ—è¡¨ -->
        <aside class="w-1/4 min-w-[280px] bg-[#F5F2EB] border-r border-[#DCD6C9] flex flex-col z-10">
            <div class="p-4 border-b border-[#E5E0D8]">
                <!-- æœå°‹æ¡† -->
                <div class="relative group">
                    <input type="text" id="addStockInput" placeholder="è¼¸å…¥ä»£è™Ÿ (å¦‚ 2330) æŒ‰ Enter" 
                           class="w-full bg-white border-2 border-[#D1C7B7] rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-[#8B7355] placeholder-gray-400 transition shadow-sm group-hover:shadow-md">
                    <button onclick="triggerAddStock()" class="absolute right-3 top-2.5 text-[#8B7355] hover:text-[#5A4A42] transition" title="è§¸ç™¼æ–°å¢">
                        <i class="fas fa-plus-circle text-lg"></i>
                    </button>
                </div>
            </div>
            
            <!-- è‚¡ç¥¨åˆ—è¡¨ -->
            <div id="stockListContainer" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
        </aside>

        <!-- å³å´ï¼šå ±å‘Šå…§å®¹ -->
        <main class="flex-1 overflow-y-auto p-6 bg-slate-50 relative" id="mainContent">
            
            <!-- åˆå§‹ç©ºç‹€æ…‹ -->
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-search-dollar text-6xl mb-6 text-[#D1C7B7]"></i>
                <p class="text-lg">è«‹é¸æ“‡å·¦å´è‚¡ç¥¨æˆ–è¼¸å…¥ä»£è™Ÿæ–°å¢åˆ†æ</p>
            </div>

            <!-- åˆ†æå ±å‘Šå®¹å™¨ -->
            <div id="reportContainer" class="hidden max-w-6xl mx-auto space-y-6 pb-20">
                
                <!-- æ¨™é¡Œèˆ‡è‚¡åƒ¹ -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end border-b-2 border-[#8B7355] pb-4 mb-6">
                    <div>
                        <h1 class="text-4xl font-bold text-[#2C3E50]">
                            <span id="stockId" class="text-[#8B7355] mr-2"></span>
                            <span id="stockName"></span>
                        </h1>
                        <p class="text-sm text-gray-500 mt-2">
                            <i class="far fa-clock mr-1"></i> æ›´æ–°æ™‚é–“ï¼š<span id="updateDate"></span>
                        </p>
                    </div>
                    <div class="text-right mt-4 md:mt-0 bg-white px-4 py-2 rounded shadow-sm border border-gray-200">
                        <div id="priceDisplay" class="text-4xl font-mono font-bold tracking-tight">--</div>
                        <div id="priceChange" class="text-sm font-bold mt-1 text-gray-400">--</div>
                    </div>
                </div>

                <!-- æŠ•è³‡ç­†è¨˜ -->
                <div class="bg-[#FFFDF5] border border-[#E8E0C0] rounded-lg p-4 shadow-sm relative">
                    <div class="text-xs font-bold text-[#8B7355] uppercase tracking-wider mb-2 flex items-center">
                        <i class="fas fa-pen-fancy mr-2"></i> æŠ•è³‡ç­†è¨˜ (Memo)
                    </div>
                    <textarea id="memoArea" rows="2" 
                              class="w-full bg-transparent border-none resize-none text-gray-700 placeholder-gray-300 focus:ring-0 text-base"
                              placeholder="é»æ“Šè¼¸å…¥ç­†è¨˜..."></textarea>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- 1. AI è­·åŸæ²³èˆ‡åŸºæœ¬é¢ (å³ä¸Šè§’é¡¯ç¤ºæ¨¡å‹) -->
                    <div class="card overflow-hidden">
                        <!-- ğŸ”¥ AI æ¨¡å‹æ¨™ç±¤ -->
                        <div class="absolute top-0 right-0 bg-[#F5F2EB] text-[#8B7355] text-[10px] px-3 py-1 rounded-bl-lg border-l border-b border-[#E5E0D8] font-mono shadow-sm">
                            <i class="fas fa-microchip mr-1"></i><span id="aiModelTag">AI</span>
                        </div>

                        <div class="card-header pt-4"> <!-- å¢åŠ ä¸Šæ–¹é–“è·çµ¦æ¨™ç±¤ -->
                            <span><i class="fas fa-shield-alt text-[#8B7355] mr-2"></i> è­·åŸæ²³èˆ‡åŸºæœ¬é¢</span>
                            <span id="moatStatus" class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">--</span>
                        </div>
                        <div class="text-sm text-gray-700 leading-relaxed text-justify space-y-3">
                            <p id="moatDesc">åˆ†æè³‡æ–™è®€å–ä¸­...</p>
                        </div>
                    </div>

                    <!-- 2. è¿‘æœŸæ–°è -->
                    <div class="card">
                        <div class="card-header pt-4">
                            <span><i class="far fa-newspaper text-[#8B7355] mr-2"></i> å¸‚å ´æ¶ˆæ¯èˆ‡æƒ…ç·’</span>
                        </div>
                        <div id="newsList" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                    </div>
                </div>

                <!-- 3. æœ¬ç›Šæ¯”æ²³æµåœ– -->
                <div class="card">
                    <div class="card-header">
                        <span><i class="fas fa-water text-[#8B7355] mr-2"></i> æœ¬ç›Šæ¯”æ²³æµåœ– (Valuation)</span>
                        <div class="text-xs font-normal text-gray-500">
                            <span class="inline-block w-2 h-2 rounded-full bg-red-400 ml-2"></span>20x
                            <span class="inline-block w-2 h-2 rounded-full bg-yellow-400 ml-2"></span>16x
                            <span class="inline-block w-2 h-2 rounded-full bg-green-400 ml-2"></span>12x
                        </div>
                    </div>
                    <div class="h-72 w-full">
                        <canvas id="peRiverChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 4. ç‡Ÿæ”¶è¶¨å‹¢ -->
                    <div class="card">
                        <div class="card-header">
                            <span><i class="fas fa-chart-bar text-[#8B7355] mr-2"></i> ç‡Ÿæ”¶è¶¨å‹¢</span>
                        </div>
                        <div class="h-60">
                            <canvas id="financialChart"></canvas>
                        </div>
                    </div>

                    <!-- 5. æŠ€è¡“é¢ -->
                    <div class="card border-l-4 border-l-[#8B7355]">
                        <div class="card-header">
                            <span><i class="fas fa-robot text-[#8B7355] mr-2"></i> æŠ€è¡“é¢ AI åˆ¤è®€</span>
                        </div>
                        <div class="space-y-4">
                            <p id="techAnalysis" class="text-sm text-gray-600 leading-relaxed">è³‡æ–™è®€å–ä¸­...</p>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-gray-50 p-3 rounded border border-gray-100">
                                    <div class="text-xs text-gray-400 mb-1">å¸ƒæ—é€šé“</div>
                                    <div id="bollingerDesc" class="font-bold text-sm text-[#2C3E50] truncate">--</div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border border-gray-100">
                                    <div class="text-xs text-gray-400 mb-1">é€²å ´å»ºè­°</div>
                                    <div id="entryZone" class="font-bold text-sm text-[#8B7355]">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- é‚è¼¯ -->
    <script>
        // --- è¨­å®šå€ (å¡«å…¥æ–°ç”³è«‹çš„ Fine-grained Token) ---
        const GITHUB_USER = "Mocha-lin"; 
        const GITHUB_REPO = "-3";       
        const GITHUB_TOKEN = "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"; // <--- è¨˜å¾—æ›æ‰ï¼

        let stocks = [];
        let currentStockId = null;
        let charts = { pe: null, fin: null };

        // 1. åˆå§‹åŒ–
        window.onload = async function() {
            renderSidebar();
            await fetchData();
        };

        // æŒ‰ Enter æ–°å¢
        document.getElementById('addStockInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') triggerAddStock();
        });

        // 2. æŠ“è³‡æ–™
        async function fetchData(force = false) {
            try {
                const url = force ? `./data.json?t=${Date.now()}` : './data.json';
                const res = await fetch(url);
                if (!res.ok) throw new Error("ç„¡æ•¸æ“š");
                const cloudData = await res.json();
                
                // åˆä½µ Local Memo
                const localStr = localStorage.getItem('bbb_db') || '[]';
                const localData = JSON.parse(localStr);
                
                let merged = cloudData.map(c => {
                    const local = localData.find(l => l.id === c.id);
                    if (local && local.memo) c.memo = local.memo;
                    return c;
                });

                stocks = merged;
                localStorage.setItem('bbb_db', JSON.stringify(stocks));
                renderSidebar();
                
                if (currentStockId) loadStock(currentStockId);
                document.getElementById('systemStatus').innerText = `ğŸŸ¢ å·²æ›´æ–°: ${new Date().toLocaleTimeString()}`;
            } catch (e) {
                console.warn(e);
                const localStr = localStorage.getItem('bbb_db');
                if (localStr) {
                    stocks = JSON.parse(localStr);
                    renderSidebar();
                }
            }
        }

        // 3. æ¸²æŸ“åˆ—è¡¨
        function renderSidebar() {
            const list = document.getElementById('stockListContainer');
            list.innerHTML = '';
            if (stocks.length === 0) {
                list.innerHTML = '<div class="text-center text-xs text-gray-400 mt-4">è«‹è¼¸å…¥ä»£è™Ÿæ–°å¢</div>';
                return;
            }

            stocks.forEach(s => {
                const item = document.createElement('div');
                item.className = `p-3 mb-2 bg-white rounded-lg cursor-pointer border hover:border-[#8B7355] transition flex justify-between items-center shadow-sm ${s.id === currentStockId ? 'border-[#8B7355] border-l-4 ring-1 ring-[#8B7355]/20' : 'border-transparent'}`;
                
                const chg = parseFloat(s.basicInfo.change) || 0;
                const color = chg > 0 ? 'text-red-500' : (chg < 0 ? 'text-green-600' : 'text-gray-500');

                item.innerHTML = `
                    <div><div class="font-bold text-gray-700">${s.id}</div><div class="text-xs text-gray-500 truncate w-24">${s.name}</div></div>
                    <div class="text-right"><div class="font-mono font-bold text-sm text-gray-800">${s.basicInfo.price}</div><div class="text-xs ${color}">${s.basicInfo.changePercent}</div></div>
                `;
                item.onclick = () => loadStock(s.id);
                list.appendChild(item);
            });
        }

        // 4. è¼‰å…¥å…§å®¹ (å« AI Model é¡¯ç¤º)
        function loadStock(id) {
            currentStockId = id;
            const s = stocks.find(k => k.id === id);
            if (!s) return;

            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('reportContainer').classList.remove('hidden');
            renderSidebar();

            document.getElementById('stockId').innerText = s.id;
            document.getElementById('stockName').innerText = s.name;
            document.getElementById('updateDate').innerText = s.lastUpdated;
            
            // é¡¯ç¤ºä½¿ç”¨çš„æ¨¡å‹ (New Feature!)
            document.getElementById('aiModelTag').innerText = s.ai_model || 'Standard AI';

            const pEl = document.getElementById('priceDisplay');
            const cEl = document.getElementById('priceChange');
            pEl.innerText = s.basicInfo.price;
            cEl.innerText = `${s.basicInfo.change} (${s.basicInfo.changePercent})`;
            const chg = parseFloat(s.basicInfo.change) || 0;
            pEl.className = `text-4xl font-mono font-bold tracking-tight ${chg > 0 ? 'text-red-500' : (chg < 0 ? 'text-green-600' : 'text-gray-800')}`;
            cEl.className = `text-sm font-bold mt-1 ${chg > 0 ? 'text-red-400' : (chg < 0 ? 'text-green-500' : 'text-gray-400')}`;

            // Memo
            const memoEl = document.getElementById('memoArea');
            memoEl.value = s.memo || "";
            memoEl.oninput = function() {
                s.memo = this.value;
                localStorage.setItem('bbb_db', JSON.stringify(stocks));
            };

            // AI Data
            document.getElementById('moatStatus').innerText = s.moat?.status || '-';
            document.getElementById('moatDesc').innerText = s.moat?.description || 'Loading...';
            document.getElementById('techAnalysis').innerText = s.technical?.analysis || 'Loading...';
            document.getElementById('bollingerDesc').innerText = s.technical?.bollinger?.status || '-';
            document.getElementById('entryZone').innerText = s.technical?.predictions?.entryZone || '-';

            // News
            const newsBox = document.getElementById('newsList');
            newsBox.innerHTML = '';
            (s.news || []).forEach(n => {
                let icon = '<i class="fas fa-circle text-gray-200 text-[6px] mt-1.5 mr-2"></i>';
                if (n.type === 'positive' || n.title.match(/å¢|æ¼²|é«˜|æ—º|å¤š/)) icon = '<i class="fas fa-caret-up text-red-500 text-lg mr-2 -mt-1"></i>';
                if (n.type === 'negative' || n.title.match(/æ¸›|è·Œ|ä½|æ·¡|ç©º/)) icon = '<i class="fas fa-caret-down text-green-500 text-lg mr-2 -mt-1"></i>';
                newsBox.innerHTML += `<div class="flex items-start pb-2 border-b border-gray-100 last:border-0"><div class="w-6 shrink-0 text-center">${icon}</div><div><div class="text-[10px] text-gray-400 font-mono">${n.date}</div><div class="text-sm text-gray-800 hover:text-[#8B7355] cursor-pointer">${n.title}</div></div></div>`;
            });

            drawCharts(s);
        }

        function drawCharts(s) {
            // PE River
            const ctxPe = document.getElementById('peRiverChart').getContext('2d');
            if (charts.pe) charts.pe.destroy();
            const peData = s.chartsData?.peRiverData || { dates: [], price: [] };
            charts.pe = new Chart(ctxPe, {
                type: 'line',
                data: {
                    labels: peData.dates,
                    datasets: [
                        { label: 'Price', data: peData.price, borderColor: '#2C3E50', borderWidth: 3, pointRadius: 2, tension: 0.1 },
                        { label: '20x', data: peData.pe20, borderColor: '#F87171', borderDash:[4,4], borderWidth:1, pointRadius:0, fill:false },
                        { label: '16x', data: peData.pe16, borderColor: '#FACC15', borderDash:[4,4], borderWidth:1, pointRadius:0, fill:'-1', backgroundColor:'rgba(248,113,113,0.05)' },
                        { label: '12x', data: peData.pe12, borderColor: '#4ADE80', borderDash:[4,4], borderWidth:1, pointRadius:0, fill:'-1', backgroundColor:'rgba(250,204,21